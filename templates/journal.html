{% extends "base.html" %}

{% block content %}
<style>
  .journal-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2em 1em;
  }

  .journal-container h1,
  .journal-container h2 {
    text-align: center;
    margin-bottom: 1em;
  }

  .journal-form textarea {
    width: 100%;
    max-width: 100%;
    height: 80px;
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 14px;
  }
  .journal-form button {
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    background: #4CAF50;
    color: white;
    font-size: 14px;
    cursor: pointer;
  }
  .journal-form button:hover {
    background: #45a049;
  }
  .entry-card {
    background: #fff;
    padding: 15px;
    margin: 10px 0;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .entry-card time {
    display: block;
    font-size: 13px;
    color: #666;
    margin-bottom: 5px;
  }
  .feedback {
    margin-top: 10px;
    padding: 10px;
    background: #f0f8ff;
    border-left: 5px solid #4CAF50;
    border-radius: 6px;
    color: #333;
  }
  .ai-feedback-btn {
    background-color: #3498db;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    margin-top: 5px;
    cursor: pointer;
  }
  .ai-feedback-btn:hover {
    background-color: #2980b9;
  }

  .journal-mode-switch {
    text-align: center;
    margin-bottom: 1em;
  }
  .journal-mode-switch button {
    margin: 0 0.3em;
  }

  /* â–¼ å‰Šé™¤ãƒœã‚¿ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ« â–¼ */
  .entry-card form {
    margin-top: 0.5em;
  }
  .delete-btn {
    background: #e57373;
    color: #fff;
    padding: 6px 10px;
    border: none;
    border-radius: 6px;
    margin-top: 5px;
    cursor: pointer;
    font-size: 14px;
  }
  .delete-btn:hover {
    background: #ef5350;
  }
  /* â–² å‰Šé™¤ãƒœã‚¿ãƒ³ã“ã“ã¾ã§ â–² */

  /* â–¼ å¿«ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆã¡ã‚‡ã£ã¨è¦‹ã‚„ã™ãï¼‰ â–¼ */
  #kaiSuggestionModal {
    display:none;
    position:fixed;
    top:30%;
    left:50%;
    transform:translate(-50%, -30%);
    background:#fff;
    padding:20px;
    border-radius:10px;
    box-shadow:0 5px 15px rgba(0,0,0,0.3);
    max-width: 420px;
    width: 90%;
    z-index: 1000;
  }
  #kaiSuggestionModal h3 {
    margin-top: 0;
    margin-bottom: 10px;
  }
  #kaiSuggestionModal p {
    font-size: 14px;
    margin-bottom: 10px;
  }
  #kaiSuggestions {
    list-style: none;
    padding-left: 0;
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 10px;
  }
  #kaiSuggestions li {
    margin-bottom: 4px;
    font-size: 14px;
  }
  #kaiSuggestionModal button {
    margin-right: 8px;
  }
  /* â–² å¿«ãƒ¢ãƒ¼ãƒ€ãƒ«ã“ã“ã¾ã§ â–² */
</style>

<div class="journal-container">
  <h1>ğŸ“ æ—¥è¨˜ã‚’æ›¸ã</h1>

  <div class="journal-mode-switch">
    <button type="button" onclick="switchMode('simple')">ğŸ“ é€šå¸¸æ—¥è¨˜ãƒ¢ãƒ¼ãƒ‰</button>
    <button type="button" onclick="switchMode('steps')">ğŸ§  6ã‚¹ãƒ†ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰</button>
  </div>

  <!-- é€šå¸¸æ—¥è¨˜ãƒ¢ãƒ¼ãƒ‰ -->
  <div id="simpleMode">
    <form method="POST"
          action="/journal/save"
          class="journal-form"
          onsubmit="return confirmKaiRegister(event);">
      <textarea name="content"
          id="journalContent"
          placeholder="ä»Šæ—¥æ„Ÿã˜ãŸã“ã¨ã‚„è€ƒãˆãŸã“ã¨ã‚’æ›¸ã„ã¦ã¿ã‚ˆã†..."
          required>{{ draft or "" }}</textarea><br>
      <input type="hidden" name="kai_extracted" id="kaiExtracted">
      <button type="submit">ä¿å­˜ã™ã‚‹</button>
    </form>

    <!-- å¿«ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒã‚§ãƒƒã‚¯ã§é¸æŠã§ãã‚‹ã‚ˆã†ã«å¤‰æ›´ï¼‰ -->
    <div id="kaiSuggestionModal">
      <h3>å¿«å€™è£œã‚’ç¢ºèª</h3>
      <p>ä»¥ä¸‹ã®ã€Œå¿«ã€ãŒæŠ½å‡ºã•ã‚Œã¾ã—ãŸã€‚<br>ä¿å­˜ã—ãŸã„ã‚‚ã®ã ã‘ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚</p>
      <ul id="kaiSuggestions"></ul>
      <button type="button" onclick="submitConfirmedJournal()">é¸æŠã—ãŸå¿«ã‚’ä¿å­˜ã™ã‚‹</button>
      <button type="button" onclick="closeKaiModal()">å¿«ã‚’ä¿å­˜ã›ãšã«æ—¥è¨˜ã ã‘ä¿å­˜</button>
    </div>
  </div>

  <!-- 6ã‚¹ãƒ†ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ -->
  <div id="stepMode" style="display: none;">
    <form method="POST" action="/journal/compose" class="journal-form">
      <textarea name="step1" placeholder="â‘  å‡ºæ¥äº‹ï¼ˆä¾‹ï¼šä¸Šå¸ã«æ³¨æ„ã•ã‚ŒãŸï¼å‹äººã¨é›»è©±ã—ãŸï¼ã‚«ãƒ•ã‚§ã«å¯„ã£ãŸï¼‰"></textarea><br>
      <textarea name="step2" placeholder="â‘¡ æ„Ÿæƒ…ï¼ˆä¾‹ï¼šæ‚²ã—ã‹ã£ãŸï¼å®‰å¿ƒã—ãŸï¼ã‚¤ãƒ©ã‚¤ãƒ©ã—ãŸï¼‰"></textarea><br>
      <textarea name="step3" placeholder="â‘¢ æ€è€ƒï¼ˆä¾‹ï¼šè‡ªåˆ†ã¯ãƒ€ãƒ¡ã‹ã‚‚ï¼é ‘å¼µã£ã¦ã‚ˆã‹ã£ãŸï¼å«Œã‚ã‚ŒãŸã‹ã‚‚ï¼‰"></textarea><br>
      <textarea name="step4" placeholder="â‘£ åˆ†æï¼ˆä¾‹ï¼šè©•ä¾¡ã‚’æ°—ã«ã—ã™ãï¼å®Œç’§ä¸»ç¾©ã ã‹ã‚‰ï¼èªã‚ã‚‰ã‚ŒãŸã„æ°—æŒã¡ï¼‰"></textarea><br>
      <textarea name="step5" placeholder="â‘¤ è¡Œå‹•ï¼ˆä¾‹ï¼šè¬ã£ãŸï¼æ•£æ­©ã—ãŸï¼ãã®ã¾ã¾å¸°ã£ãŸï¼‰"></textarea><br>
      <textarea name="step6" placeholder="â‘¥ çµæœï¼ˆä¾‹ï¼šç›¸æ‰‹ãŒç¬‘ã£ã¦ãã‚ŒãŸï¼å°‘ã—å‰å‘ãã«ãªã‚ŒãŸï¼æ°—ã¥ããŒã‚ã£ãŸï¼‰"></textarea><br>
      <button type="submit">ğŸ“ AIã«ã¾ã¨ã‚ã¦ã‚‚ã‚‰ã†</button>
    </form>
  </div>

  <hr>
  <h2>ğŸ“˜ éå»ã®æ—¥è¨˜ä¸€è¦§</h2>
  {% if entries %}
    {% for entry in entries %}
      <div class="entry-card">
        <time>{{ entry.created_at|jst("%Y-%m-%d %H:%M") }}</time>
        <p>{{ entry.content }}</p>

        <!-- AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
        <form method="POST" action="/journal/feedback">
          <input type="hidden" name="entry_id" value="{{ entry.id }}">
          <button type="submit" class="ai-feedback-btn">ğŸ§  AIã«æ„Ÿæƒ³ã‚’ã‚‚ã‚‰ã†</button>
        </form>

        {% if entry.feedback %}
          <div class="feedback">ğŸ’¬ {{ entry.feedback }}</div>
        {% endif %}

        <!-- æ—¥è¨˜å‰Šé™¤ãƒœã‚¿ãƒ³ -->
        <form method="POST"
              action="{{ url_for('journal_delete', entry_id=entry.id) }}"
              onsubmit="return confirm('ã“ã®æ—¥è¨˜ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
          <button type="submit" class="delete-btn">ğŸ—‘ å‰Šé™¤</button>
        </form>

      </div>
    {% endfor %}
  {% else %}
    <p>ã¾ã æ—¥è¨˜ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endif %}
</div>

<script>
function switchMode(mode) {
  document.getElementById("simpleMode").style.display =
    (mode === "simple") ? "block" : "none";
  document.getElementById("stepMode").style.display =
    (mode === "steps") ? "block" : "none";
}

function confirmKaiRegister(event) {
  event.preventDefault();

  const form = document.querySelector("#simpleMode form");
  const textarea = document.getElementById("journalContent");
  const content = (textarea.value || "").trim();

  if (!content) {
    alert("æ—¥è¨˜ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ã­");
    textarea.focus();
    return false;
  }

  fetch("/journal/extract_kai", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ content })
  })
  .then(res => res.json())
  .then(data => {
    if (data.kai && data.kai.length > 0) {
      const ul = document.getElementById("kaiSuggestions");
      ul.innerHTML = "";

      // æŠ½å‡ºã•ã‚ŒãŸå¿«ã‚’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä»˜ãã§è¡¨ç¤º
      data.kai.forEach(k => {
        const li = document.createElement("li");

        const label = document.createElement("label");

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "kai-checkbox";
        checkbox.value = k;
        checkbox.checked = true;

        const span = document.createElement("span");
        span.textContent = " " + k;

        label.appendChild(checkbox);
        label.appendChild(span);
        li.appendChild(label);
        ul.appendChild(li);
      });

      document.getElementById("kaiSuggestionModal").style.display = "block";
    } else {
      // å¿«ãŒæŠ½å‡ºã•ã‚Œãªã‹ã£ãŸå ´åˆã¯ã€ãã®ã¾ã¾æ—¥è¨˜ã ã‘ä¿å­˜
      form.submit();
    }
  })
  .catch(err => {
    console.error("å¿«æŠ½å‡ºã‚¨ãƒ©ãƒ¼:", err);
    // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚æ—¥è¨˜ã ã‘ã¯ä¿å­˜
    form.submit();
  });

  return false;
}

function submitConfirmedJournal() {
  // ãƒã‚§ãƒƒã‚¯ãŒå…¥ã£ã¦ã„ã‚‹å¿«ã ã‘ã‚’é›†ã‚ã‚‹
  const checkboxes = Array.from(
    document.querySelectorAll("#kaiSuggestions .kai-checkbox")
  );

  const selected = checkboxes
    .filter(cb => cb.checked)
    .map(cb => cb.value);

  const hidden = document.getElementById("kaiExtracted");

  if (selected.length > 0) {
    hidden.value = JSON.stringify(selected);
  } else {
    // ã²ã¨ã¤ã‚‚é¸ã°ãªã‹ã£ãŸå ´åˆã¯ã€å¿«ã¯ä¿å­˜ã—ãªã„ï¼ˆç©ºã§é€ã‚‹ï¼‰
    hidden.value = "";
  }

  document.getElementById("kaiSuggestionModal").style.display = "none";
  document.querySelector("#simpleMode form").submit();
}

function closeKaiModal() {
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦
  document.getElementById("kaiSuggestionModal").style.display = "none";
  // å¿«ã¯ç™»éŒ²ã—ãªã„ã®ã§ hidden ã¯ç©ºã®ã¾ã¾
  document.getElementById("kaiExtracted").value = "";
  // æ—¥è¨˜ã ã‘ä¿å­˜ã™ã‚‹
  document.querySelector("#simpleMode form").submit();
}
</script>
{% endblock %}
