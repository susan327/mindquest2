{% extends "base.html" %}

{% block content %}
<style>
  .kai-container {
    max-width: 700px;
    margin: 0 auto;
    padding: 2em 1em;
  }

  .kai-container h2,
  .kai-container h3 {
    text-align: center;
    margin-bottom: 1em;
  }

  ul.kai-list {
    list-style: none;
    padding: 0;
  }
  ul.kai-list li {
    margin-bottom: 10px;
    background: #fff;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .kai-container button {
    margin-left: 10px;
    padding: 5px 10px;
    border-radius: 6px;
    border: none;
    background: #4CAF50;
    color: white;
    cursor: pointer;
    display: inline-block;
  }
  .kai-container button:hover {
    background: #45a049;
  }
  .kai-container input[type="text"] {
    padding: 5px;
    border-radius: 6px;
    border: 1px solid #ccc;
    width: 200px;
  }
  #kaiModal {
    display: none;
    position: fixed;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -30%);
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }

  .kai-presets {
    text-align: center;
    margin-top: 1em;
  }
  .kai-presets button {
    margin: 0.3em;
  }
</style>

<div class="kai-container">
  <h2>ğŸ§˜â€â™€ï¸ ã‚ãªãŸã®å¿«ï¼ˆå®Ÿè¡Œå›æ•°ã¤ãï¼‰</h2>
  <ul class="kai-list" id="kaiList">
    <li>èª­ã¿è¾¼ã¿ä¸­...</li>
  </ul>

  <h3>ï¼‹ å¿«ã‚’è¿½åŠ ã™ã‚‹</h3>
  <div style="margin-bottom: 1em; text-align: center;">
    <input type="text" id="customKaiInput" placeholder="è‡ªç”±ã«å¿«ã‚’å…¥åŠ›..." />
    <button onclick="submitCustomKai()">ç™»éŒ²</button>
  </div>

  <div class="kai-presets">
    <button onclick="confirmKai('æœã®æ•£æ­©')">æœã®æ•£æ­©</button>
    <button onclick="confirmKai('ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’é£²ã‚€æ™‚é–“')">ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’é£²ã‚€æ™‚é–“</button>
    <button onclick="confirmKai('æ—¥è¨˜ã‚’æ›¸ãæ™‚é–“')">æ—¥è¨˜ã‚’æ›¸ãæ™‚é–“</button>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="kaiModal">
  <p id="kaiConfirmText">ã“ã®è¡Œå‹•ã‚’å¿«ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ</p>
  <button onclick="submitKai()">ã¯ã„</button>
  <button onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<script>
  let selectedKai = "";

  function confirmKai(kai) {
    selectedKai = kai;
    document.getElementById("kaiConfirmText").innerText = `ã€Œ${kai}ã€ã‚’å¿«ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`;
    document.getElementById("kaiModal").style.display = "block";
  }

  function closeModal() {
    document.getElementById("kaiModal").style.display = "none";
    selectedKai = "";
  }

  function submitKai() {
    fetch("/register_kai", {
      method: "POST",
      body: JSON.stringify({ kai: selectedKai }),
      headers: { "Content-Type": "application/json" },
    }).then(() => {
      alert("ç™»éŒ²ã—ã¾ã—ãŸï¼");
      closeModal();
      location.reload();
    });
  }

  function deleteKai(kai) {
    if (confirm(`æœ¬å½“ã«ã€Œ${kai}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      fetch("/delete_kai", {
        method: "POST",
        body: JSON.stringify({ kai }),
        headers: { "Content-Type": "application/json" },
      }).then(() => {
        alert("å‰Šé™¤ã—ã¾ã—ãŸ");
        location.reload();
      });
    }
  }

  function submitCustomKai() {
    const input = document.getElementById("customKaiInput");
    const kai = input.value.trim();
    if (!kai) {
      alert("å¿«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
      return;
    }

    fetch("/register_kai", {
      method: "POST",
      body: JSON.stringify({ kai }),
      headers: { "Content-Type": "application/json" },
    }).then(() => {
      alert("ç™»éŒ²ã—ã¾ã—ãŸï¼");
      input.value = "";
      location.reload();
    });
  }

  // âœ… å¿«ä¸€è¦§ã®å–å¾—ãƒ»å‹•çš„è¡¨ç¤º
  window.onload = () => {
    fetch("/api/kai_status")
      .then(res => res.json())
      .then(data => {
        const ul = document.getElementById("kaiList");
        ul.innerHTML = "";

        if (!data.logs || data.logs.length === 0) {
          ul.innerHTML = "<li>ã¾ã å¿«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</li>";
        } else {
          data.logs.forEach(log => {
            const li = document.createElement("li");
            li.innerHTML = `ğŸŒŸ ${log.name}ï¼ˆ${log.count}å›ï¼‰ <button onclick="deleteKai('${log.name}')">å‰Šé™¤</button>`;
            ul.appendChild(li);
          });
        }
      })
      .catch(err => {
        console.error("å¿«ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
        document.getElementById("kaiList").innerHTML = "<li>å¿«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</li>";
      });
  };
</script>
{% endblock %}
