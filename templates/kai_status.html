{% extends "base.html" %}

{% block content %}
<style>
  .kai-container {
    max-width: 700px;
    margin: 0 auto;
    padding: 2em 1em;
  }

  .kai-container h2,
  .kai-container h3 {
    text-align: center;
    margin-bottom: 1em;
  }

  /* ä¸¦ã³æ›¿ãˆã‚»ãƒ¬ã‚¯ãƒˆ */
  .kai-sort-row {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 8px;
    margin-bottom: 0.5em;
    font-size: 0.9rem;
  }

  .kai-sort-row select {
    padding: 4px 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 0.9rem;
  }

  /* å¿«ãƒªã‚¹ãƒˆå…¨ä½“ */
  ul.kai-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  /* 1ã¤1ã¤ã®å¿«ã‚«ãƒ¼ãƒ‰ */
  .kai-item {
    background: #fff;
    padding: 10px 12px;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
  }

  /* å¿«ã®ãƒ¡ã‚¤ãƒ³éƒ¨åˆ†ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‹å›æ•°ï¼‹æ—¥ä»˜ï¼‰ */
  .kai-main {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .kai-title {
    font-size: 0.95rem;
  }

  .kai-meta {
    font-size: 0.85rem;
    color: #666;
  }

  /* å‰Šé™¤ãƒœã‚¿ãƒ³ã¯å³ä¸‹ã«å°ã•ãé…ç½® */
  .kai-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 6px;
  }

  .btn-kai-delete {
    background: #e57373;
    padding: 4px 10px;
    font-size: 0.8rem;
    border-radius: 999px;
    border: none;
    color: #fff;
    cursor: pointer;

    /* ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®ã€Œãƒœã‚¿ãƒ³å¹…100%ã€ã‚’æ‰“ã¡æ¶ˆã™ */
    display: inline-block;
    width: auto !important;
    max-width: fit-content;
  }

  .btn-kai-delete:hover {
    background: #ef5350;
  }

  .kai-container input[type="text"] {
    padding: 5px 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    width: 70%;
    max-width: 260px;
    box-sizing: border-box;
  }

  .kai-container .btn-primary {
    margin-left: 8px;
    padding: 6px 12px;
    border-radius: 6px;
    border: none;
    background: #4CAF50;
    color: white;
    cursor: pointer;
    display: inline-block;
  }

  .kai-container .btn-primary:hover {
    background: #45a049;
  }

  #kaiModal {
    display: none;
    position: fixed;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -30%);
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    z-index: 999;
  }

  .kai-presets {
    text-align: center;
    margin-top: 1em;
  }

  .kai-presets button {
    margin: 0.3em;
    padding: 6px 10px;
    border-radius: 999px;
    border: none;
    background: #eee;
    cursor: pointer;
  }

  .kai-presets button:hover {
    background: #ddd;
  }

  @media (max-width: 768px) {
    .kai-item {
      padding: 8px 10px;
    }

    .kai-sort-row {
      justify-content: center;
    }
  }
</style>

<div class="kai-container">
  <h2>ğŸ§˜â€â™€ï¸ ã‚ãªãŸã®å¿«ï¼ˆå®Ÿè¡Œå›æ•°ã¤ãï¼‰</h2>

  <div class="kai-sort-row">
    <label for="kaiSort">ä¸¦ã³æ›¿ãˆï¼š</label>
    <select id="kaiSort" onchange="renderKaiList()">
      <option value="date_new">æ›´æ–°ãŒæ–°ã—ã„é †</option>
      <option value="date_old">æ›´æ–°ãŒå¤ã„é †</option>
      <option value="count_desc">å¤šã„é †</option>
      <option value="count_asc">å°‘ãªã„é †</option>
    </select>
  </div>

  <ul class="kai-list" id="kaiList">
    <li>èª­ã¿è¾¼ã¿ä¸­...</li>
  </ul>

  <h3>ï¼‹ å¿«ã‚’è¿½åŠ ã™ã‚‹</h3>
  <div style="margin-bottom: 1em; text-align: center;">
    <input type="text" id="customKaiInput" placeholder="è‡ªç”±ã«å¿«ã‚’å…¥åŠ›..." />
    <button class="btn-primary" onclick="submitCustomKai()">ç™»éŒ²</button>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="kaiModal">
  <p id="kaiConfirmText">ã“ã®è¡Œå‹•ã‚’å¿«ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ</p>
  <button class="btn-primary" onclick="submitKai()">ã¯ã„</button>
  <button class="btn-kai-delete" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<script>
  let selectedKai = "";
  let kaiLogs = [];  // APIã‹ã‚‰å—ã‘å–ã£ãŸå¿«ä¸€è¦§ã‚’ä¿æŒ

  function confirmKai(kai) {
    selectedKai = kai;
    document.getElementById("kaiConfirmText").innerText =
      `ã€Œ${kai}ã€ã‚’å¿«ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`;
    document.getElementById("kaiModal").style.display = "block";
  }

  function closeModal() {
    document.getElementById("kaiModal").style.display = "none";
    selectedKai = "";
  }

  function submitKai() {
    fetch("/register_kai", {
      method: "POST",
      body: JSON.stringify({ kai: selectedKai }),
      headers: { "Content-Type": "application/json" },
    }).then(() => {
      alert("ç™»éŒ²ã—ã¾ã—ãŸï¼");
      closeModal();
      location.reload();
    });
  }

  function deleteKai(kai) {
    if (confirm(`æœ¬å½“ã«ã€Œ${kai}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      fetch("/delete_kai", {
        method: "POST",
        body: JSON.stringify({ kai }),
        headers: { "Content-Type": "application/json" },
      }).then(() => {
        alert("å‰Šé™¤ã—ã¾ã—ãŸ");
        location.reload();
      });
    }
  }

  function submitCustomKai() {
    const input = document.getElementById("customKaiInput");
    const kai = input.value.trim();
    if (!kai) {
      alert("å¿«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
      return;
    }

    fetch("/register_kai", {
      method: "POST",
      body: JSON.stringify({ kai }),
      headers: { "Content-Type": "application/json" },
    }).then(() => {
      alert("ç™»éŒ²ã—ã¾ã—ãŸï¼");
      input.value = "";
      location.reload();
    });
  }

  // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆYYYY-MM-DD HH:MMï¼‰
  function formatKaiDate(isoString) {
    if (!isoString) return "";
    const d = new Date(isoString);
    if (isNaN(d.getTime())) return "";

    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mi = String(d.getMinutes()).padStart(2, "0");

    return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
  }

  // ä¸¦ã³æ›¿ãˆï¼†æç”»
  function renderKaiList() {
    const ul = document.getElementById("kaiList");
    const modeSelect = document.getElementById("kaiSort");
    const mode = modeSelect ? modeSelect.value : "date_new";

    if (!kaiLogs || kaiLogs.length === 0) {
      ul.innerHTML = "<li>ã¾ã å¿«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</li>";
      return;
    }

    const sorted = [...kaiLogs];

    // ä¸¦ã³æ›¿ãˆæ¡ä»¶
    sorted.sort((a, b) => {
      const aCount = a.count || 0;
      const bCount = b.count || 0;
      const aTime = a.created_at ? new Date(a.created_at).getTime() : 0;
      const bTime = b.created_at ? new Date(b.created_at).getTime() : 0;

      switch (mode) {
        case "count_desc":  // å¤šã„é †
          return bCount - aCount;
        case "count_asc":   // å°‘ãªã„é †
          return aCount - bCount;
        case "date_old":    // æ›´æ–°ãŒå¤ã„é †
          return aTime - bTime;
        case "date_new":    // æ›´æ–°ãŒæ–°ã—ã„é †ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
        default:
          return bTime - aTime;
      }
    });

    ul.innerHTML = "";
    sorted.forEach(log => {
      const li = document.createElement("li");
      li.className = "kai-item";

      const dateText = formatKaiDate(log.created_at);
      const metaText = dateText
        ? `ï¼ˆ${log.count}å›ï¼æœ€çµ‚è¿½åŠ ï¼š${dateText}ï¼‰`
        : `ï¼ˆ${log.count}å›ï¼‰`;

      li.innerHTML = `
        <div class="kai-main">
          <div class="kai-title">ğŸŒŸ ${log.name}</div>
          <div class="kai-meta">${metaText}</div>
        </div>
        <div class="kai-actions">
          <button class="btn-kai-delete"
            onclick="deleteKai('${log.name.replace(/'/g, "\\'")}')">
            å‰Šé™¤
          </button>
        </div>
      `;
      ul.appendChild(li);
    });
  }

  // åˆå›èª­ã¿è¾¼ã¿
  window.addEventListener("load", () => {
    fetch("/api/kai_status")
      .then(res => res.json())
      .then(data => {
        if (!data.ok) {
          throw new Error("APIã‚¨ãƒ©ãƒ¼");
        }
        kaiLogs = data.logs || [];
        renderKaiList();
      })
      .catch(err => {
        console.error("å¿«ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
        document.getElementById("kaiList").innerHTML =
          "<li>å¿«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</li>";
      });
  });
</script>
{% endblock %}
