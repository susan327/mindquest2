{% extends "base.html" %}

{% block title %}å†’é™ºãƒ­ã‚°{% endblock %}

{% block content %}
<div class="container" style="max-width: 900px; margin: 0 auto;">

  <h1 style="margin-top: 20px; margin-bottom: 10px;">å†’é™ºãƒ­ã‚°</h1>
  <p style="color:#555; font-size:14px;">
    ã‚¯ã‚¨ã‚¹ãƒˆã®æŒ¯ã‚Šè¿”ã‚Šã¨è¨ºæ–­çµæœã®å±¥æ­´ã‚’ã¾ã¨ã‚ã¦ç¢ºèªã§ãã¾ã™ã€‚
  </p>

  <!-- ==============================
       ã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°
  =============================== -->
  <h2 style="margin-top: 30px; margin-bottom: 10px;">ğŸ—º ã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°</h2>

  {% if quest_logs %}
    {% for log, quest in quest_logs %}
      <div style="margin-bottom:18px; padding:14px 18px; border-radius:12px; background:#f8f8ff; border:1px solid #e0e0ff;">

        <!-- æ—¥ä»˜ -->
        <div style="font-size:13px; color:#666;">
          {{ log.created_at|jst("%Y-%m-%d %H:%M") }}
        </div>

        <!-- ã‚¯ã‚¨ã‚¹ãƒˆå -->
        <div style="font-weight:bold; margin:6px 0 10px 0; font-size:16px;">
          {{ quest.title }}
        </div>

        <!-- â–¼ ã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ç­” -->
        {% if log.steps_data %}
          <details style="font-size:14px; margin-bottom:10px;">
            <summary style="cursor:pointer; color:#333; font-weight:600;">
              â–¼ ã‚¯ã‚¨ã‚¹ãƒˆã®å†…å®¹ã¨ã‚ãªãŸã®å›ç­”ã‚’ã²ã‚‰ã
            </summary>

            <div style="margin-top:8px; padding-left:5px;">
              {% for step in log.steps_data %}
                <div style="margin-bottom:14px; padding-bottom:8px; border-bottom:1px solid #eee;">
                  <div style="font-weight:bold; margin-bottom:4px; color:#333;">
                    STEP {{ loop.index }}ï¼š{{ step.title }}
                  </div>

                  {% if step.answer %}
                    <div style="font-size:13px; line-height:1.6;">
                      {{ step.answer | replace("\n", "<br>") | safe }}
                    </div>
                  {% else %}
                    <div style="color:#888; font-size:12px;">
                      ï¼ˆã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯æœªå…¥åŠ›ã§ã—ãŸï¼‰
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </details>
        {% endif %}

        <!-- â–¼ æœ€å¾Œã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆè‡ªåˆ†ã®æŒ¯ã‚Šè¿”ã‚Šãƒ¡ãƒ¢ï¼‰ -->
        {% if log.raw_feedback %}
          <div style="font-size:14px; margin-bottom:10px;">
            <span style="font-weight:bold;">ğŸ“ æœ€å¾Œã®ã²ã¨ã“ã¨ãƒ¡ãƒ¢ï¼š</span><br>
            {{ log.raw_feedback | replace("\n", "<br>") | safe }}
          </div>
        {% endif %}

        <!-- â–¼ AI ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
        {% if log.ai_feedback %}
          <div style="font-size:14px; background:#ffffff; border-radius:10px; padding:10px 12px; border:1px solid #d5d5ff;">
            <span style="font-weight:bold;">ğŸ¤– AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼š</span><br>
            {{ log.ai_feedback | replace("\n", "<br>") | safe }}
          </div>
        {% endif %}

      </div>
    {% endfor %}
  {% else %}
    <p style="font-size:13px; color:#777;">ã¾ã ã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endif %}



  <!-- ==============================
       è¨ºæ–­ãƒ­ã‚°
  =============================== -->
  <h2 style="margin-top: 40px; margin-bottom: 10px; text-align:center;">
    ğŸ§  è¨ºæ–­ãƒ­ã‚°
  </h2>

  {% if diagnosis_logs %}
    {% for row in diagnosis_logs %}
      {% set info = type_info.get(row.top_type) if type_info else None %}

      <div style="margin-bottom:18px; padding:14px 18px; border-radius:12px; background:#f7fcff; border:1px solid #d0e8ff;">

        <!-- æ—¥ä»˜ -->
        <div style="font-size:13px; color:#666;">
          {{ row.created_at|jst("%Y-%m-%d %H:%M") }}
        </div>

        <!-- ã‚¿ã‚¤ãƒ—è¡¨ç¤º -->
        <div style="font-weight:bold; margin:6px 0 8px 0; font-size:16px;">
          çµæœï¼š
          {% if info %}
            {{ info.name }}ï¼ˆ{{ row.top_type }}ï¼‰
          {% else %}
            {{ row.top_type or "æœªåˆ¤å®š" }}
          {% endif %}
        </div>

        <!-- ã‚¹ã‚³ã‚¢ï¼ˆdictãã®ã¾ã¾ã˜ã‚ƒãªãã€ã‚¿ã‚°è¡¨ç¤ºã«ã™ã‚‹ï¼‰ -->
        {% if row.scores %}
          <div style="font-size:13px; margin-bottom:6px;">
            <span style="font-weight:bold;">ğŸ“Š ã‚¹ã‚³ã‚¢ï¼š</span>
            <div style="margin-top:4px;">
              {% for tkey, score in row.scores.items() %}
                {% set tinfo = type_info.get(tkey) if type_info else None %}
                <span style="
                  display:inline-block;
                  padding:2px 8px;
                  margin:2px 4px 2px 0;
                  border-radius:999px;
                  background:#eef5ff;
                  font-size:12px;
                ">
                  {{ tinfo.name if tinfo else tkey }}ï¼š{{ score }}
                </span>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        <!-- è¨ºæ–­æ™‚ã®è‡ªç”±è¨˜è¿°ï¼ˆ3ã¤ã®å•ã„ã«åˆã‚ã›ãŸãƒ©ãƒ™ãƒ«ï¼‰ -->
        {% if row.written1 or row.written2 or row.written3 %}
          <details style="font-size:13px; color:#555; margin-top:6px;">
            <summary style="cursor:pointer;">â–¼ è¨ºæ–­æ™‚ã«æ›¸ã„ãŸå†…å®¹ã‚’è¦‹ã‚‹</summary>

            <div style="margin-top:8px;">

              {% if row.written1 %}
                <p style="font-size:13px; margin-bottom:6px;">
                  <strong>1. ã‚ãªãŸãŒã€Œè‡ªåˆ†ã‚‰ã—ã„ã€ã¨æ„Ÿã˜ã‚‹ã®ã¯ã©ã‚“ãªã¨ãã§ã™ã‹ï¼Ÿ</strong><br>
                  {{ row.written1 | replace("\n", "<br>") | safe }}
                </p>
              {% endif %}

              {% if row.written2 %}
                <p style="font-size:13px; margin-bottom:6px;">
                  <strong>2. äººã¨é–¢ã‚ã‚‹ä¸­ã§ã€å°è±¡ã«æ®‹ã£ã¦ã„ã‚‹ã†ã‚Œã—ã‹ã£ãŸã“ã¨ãƒ»ã¤ã‚‰ã‹ã£ãŸã“ã¨ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚</strong><br>
                  {{ row.written2 | replace("\n", "<br>") | safe }}
                </p>
              {% endif %}

              {% if row.written3 %}
                <p style="font-size:13px;">
                  <strong>3. ã‚ãªãŸãŒã€Œç†æƒ³ã®è‡ªåˆ†ã€ã ã¨è€ƒãˆã‚‹æ€§æ ¼ã‚„è¡Œå‹•ã‚’è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„ã€‚</strong><br>
                  {{ row.written3 | replace("\n", "<br>") | safe }}
                </p>
              {% endif %}

            </div>
          </details>
        {% endif %}

      </div>

    {% endfor %}
  {% else %}
    <p style="font-size:13px; color:#777;">ã¾ã è¨ºæ–­ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endif %}

</div>
{% endblock %}
