{% extends "base.html" %}

{% block title %}å†’é™ºãƒ­ã‚°{% endblock %}

{% block content %}
<div class="container" style="max-width: 900px; margin: 0 auto;">

  <h1 style="margin-top: 20px; margin-bottom: 10px;">å†’é™ºãƒ­ã‚°</h1>
  <p style="color:#555; font-size:14px;">
    ã‚¯ã‚¨ã‚¹ãƒˆã®æŒ¯ã‚Šè¿”ã‚Šã¨è¨ºæ–­çµæœã®å±¥æ­´ã‚’ã¾ã¨ã‚ã¦ç¢ºèªã§ãã¾ã™ã€‚
  </p>

  <!-- ==============================
        è¨ºæ–­ãƒ­ã‚°ã¸ã®ãƒªãƒ³ã‚¯
  ============================== -->
  <div style="text-align:center; margin: 20px 0;">
    <a href="#diagnosis-section" style="
      display:inline-block;
      padding: 8px 16px;
      background:#eef3ff;
      border:1px solid #ccd5ff;
      border-radius:8px;
      font-size:14px;
      text-decoration:none;
      color:#334;
    ">
      ğŸ§  è¨ºæ–­ãƒ­ã‚°ã‚’è¦‹ã‚‹
    </a>
  </div>


  <!-- ==============================
        ã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°
  ============================== -->
  <h2 id="quest-section" style="margin-top: 30px; margin-bottom: 10px; text-align:center;">
    ğŸ—º ã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°
  </h2>

  {% if quest_logs %}
    {% for log, quest in quest_logs %}
      <div style="margin-bottom:18px; padding:14px 18px; border-radius:12px;
          background:#f8f8ff; border:1px solid #e0e0ff;">

        <!-- æ—¥ä»˜ -->
        <div style="font-size:13px; color:#666;">
          {{ log.created_at|jst("%Y-%m-%d %H:%M") }}
        </div>

        <!-- ã‚¯ã‚¨ã‚¹ãƒˆå -->
        <div style="font-weight:bold; margin:6px 0 10px 0; font-size:16px;">
          {{ quest.title }}
        </div>

        <!-- â–¼ ã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ç­”ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
        {% if log.steps_data %}
          <details style="font-size:14px; margin-bottom:10px;">
            <summary style="cursor:pointer; color:#333; font-weight:600; padding:4px 0;">
              â–¶ ã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã¨å›ç­”ã‚’è¦‹ã‚‹
            </summary>

            <div style="margin-top:8px; padding-left:5px;">
              {% for step in log.steps_data %}
                <div style="margin-bottom:14px; padding-bottom:8px; border-bottom:1px solid #eee;">
                  <div style="font-weight:bold; margin-bottom:4px; color:#333;">
                    STEP {{ loop.index }}ï¼š{{ step.title }}
                  </div>

                  {% if step.answer %}
                    <div style="font-size:13px; line-height:1.6;">
                      {{ step.answer | replace("\n", "<br>") | safe }}
                    </div>
                  {% else %}
                    <div style="color:#888; font-size:12px;">
                      ï¼ˆã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯æœªå…¥åŠ›ã§ã—ãŸï¼‰
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </details>
        {% endif %}

        <!-- â–¼ æœ€å¾Œã®ãƒ¡ãƒ¢ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
        {% if log.raw_feedback %}
          <details style="font-size:14px; margin-bottom:10px;">
            <summary style="cursor:pointer; padding:4px 0; font-weight:600;">
              â–¶ ã‚ãªãŸã®æŒ¯ã‚Šè¿”ã‚Šãƒ¡ãƒ¢ã‚’è¦‹ã‚‹
            </summary>
            <div style="margin-top:8px;">
              {{ log.raw_feedback | replace("\n", "<br>") | safe }}
            </div>
          </details>
        {% endif %}

        <!-- â–¼ AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
        {% if log.ai_feedback %}
          <details style="font-size:14px;">
            <summary style="cursor:pointer; padding:4px 0; font-weight:600;">
              â–¶ AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¦‹ã‚‹
            </summary>
            <div style="margin-top:8px; background:#ffffff;
                border-radius:10px; padding:10px 12px; border:1px solid #d5d5ff;">
              {{ log.ai_feedback | replace("\n", "<br>") | safe }}
            </div>
          </details>
        {% endif %}

      </div>
    {% endfor %}
  {% else %}
    <p style="font-size:13px; color:#777;">ã¾ã ã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endif %}



  <!-- ==============================
        ã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°ã¸ã®ãƒªãƒ³ã‚¯
  ============================== -->
  <div style="text-align:center; margin: 30px 0 10px;">
    <a href="#quest-section" style="
      display:inline-block;
      padding: 8px 16px;
      background:#f0f8ff;
      border:1px solid #c0e0ff;
      border-radius:8px;
      font-size:14px;
      text-decoration:none;
      color:#334;
    ">
      ğŸ—º ã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°ã‚’è¦‹ã‚‹
    </a>
  </div>


  <!-- ==============================
        è¨ºæ–­ãƒ­ã‚°
  ============================== -->
  <h2 id="diagnosis-section" style="margin-top: 20px; margin-bottom: 10px; text-align:center;">
    ğŸ§  è¨ºæ–­ãƒ­ã‚°
  </h2>

  {% if diagnosis_logs %}
    {% for row in diagnosis_logs %}
      {% set info = type_info.get(row.top_type) if type_info else None %}

      <div style="margin-bottom:18px; padding:14px 18px; border-radius:12px;
          background:#f7fcff; border:1px solid #d0e8ff;">

        <!-- æ—¥ä»˜ -->
        <div style="font-size:13px; color:#666;">
          {{ row.created_at|jst("%Y-%m-%d %H:%M") }}
        </div>

        <!-- ã‚¿ã‚¤ãƒ—è¡¨ç¤º -->
        <div style="font-weight:bold; margin:6px 0 8px 0; font-size:16px;">
          çµæœï¼š
          {% if info %}
            {{ info.name }}ï¼ˆ{{ row.top_type }}ï¼‰
          {% else %}
            {{ row.top_type or "æœªåˆ¤å®š" }}
          {% endif %}
        </div>

        <!-- ã‚¹ã‚³ã‚¢ã‚¿ã‚° -->
        {% if row.scores %}
          <div style="font-size:13px; margin-bottom:6px;">
            <span style="font-weight:bold;">ğŸ“Š ã‚¹ã‚³ã‚¢ï¼š</span>
            <div style="margin-top:4px;">
              {% for tkey, score in row.scores.items() %}
                {% set tinfo = type_info.get(tkey) if type_info else None %}
                <span style="
                  display:inline-block;
                  padding:2px 8px;
                  margin:2px 4px 2px 0;
                  border-radius:999px;
                  background:#eef5ff;
                  font-size:12px;
                ">
                  {{ tinfo.name if tinfo else tkey }}ï¼š{{ score }}
                </span>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        <!-- â–¼ è‡ªç”±è¨˜è¿°ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
        {% if row.written1 or row.written2 or row.written3 %}
          <details style="font-size:13px; color:#555; margin-top:6px;">
            <summary style="cursor:pointer;">â–¶ è¨ºæ–­æ™‚ã«æ›¸ã„ãŸå†…å®¹ã‚’è¦‹ã‚‹</summary>

            <div style="margin-top:8px;">
              {% if row.written1 %}
                <p style="font-size:13px; margin-bottom:6px;">
                  <strong>1. ã‚ãªãŸãŒã€Œè‡ªåˆ†ã‚‰ã—ã„ã€ã¨æ„Ÿã˜ã‚‹ã®ã¯ã©ã‚“ãªã¨ãã§ã™ã‹ï¼Ÿ</strong><br>
                  {{ row.written1 | replace("\n", "<br>") | safe }}
                </p>
              {% endif %}

              {% if row.written2 %}
                <p style="font-size:13px; margin-bottom:6px;">
                  <strong>
                    2. äººã¨é–¢ã‚ã‚‹ä¸­ã§ã€å°è±¡ã«æ®‹ã£ã¦ã„ã‚‹ã†ã‚Œã—ã‹ã£ãŸã“ã¨ãƒ»ã¤ã‚‰ã‹ã£ãŸã“ã¨ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚
                  </strong><br>
                  {{ row.written2 | replace("\n", "<br>") | safe }}
                </p>
              {% endif %}

              {% if row.written3 %}
                <p style="font-size:13px;">
                  <strong>3. ã‚ãªãŸãŒã€Œç†æƒ³ã®è‡ªåˆ†ã€ã ã¨è€ƒãˆã‚‹æ€§æ ¼ã‚„è¡Œå‹•ã‚’è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„ã€‚</strong><br>
                  {{ row.written3 | replace("\n", "<br>") | safe }}
                </p>
              {% endif %}
            </div>
          </details>
        {% endif %}
      </div>

    {% endfor %}
  {% else %}
    <p style="font-size:13px; color:#777;">ã¾ã è¨ºæ–­ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endif %}

</div>


<!-- â–¼ ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« -->
<script>
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener("click", function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute("href"));
      if (target) {
        target.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    });
  });
</script>

{% endblock %}
